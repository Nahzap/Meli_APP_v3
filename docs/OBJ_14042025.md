# Planificación Módulo QR_code

## Objetivo

Crear un módulo único para la generación y gestión de códigos QR vinculados a los identificadores únicos de usuarios/apicultores en el sistema, reutilizando el mecanismo existente de redirección mediante segmentos UUID. El módulo utilizará la biblioteca `segno`, reconocida por ser optimizada y cumplir con los estándares ISO/IEC. 

La implementación incluirá una interfaz de usuario con dos botones específicos:
- Un botón "Generar QR" que, al ser presionado, generará y mostrará el código QR del usuario
- Un botón "Guardar QR" junto al anterior que permitirá descargar la imagen generada (opción no obligatoria)

## Análisis del Mecanismo Actual

Actualmente, el sistema ya cuenta con un mecanismo para identificar usuarios mediante segmentos UUID:

1. **Generación de segmento UUID**: El método `get_uuid_segment()` en la clase `NavegadorSupabase` extrae los primeros 8 caracteres del UUID de un usuario.
   ```python
   # Ejemplo en buscador.py
   def get_uuid_segment(self, uuid_str: str) -> str:
       """Extrae el primer segmento (8 caracteres) de un UUID."""
       if not uuid_str or not isinstance(uuid_str, str):
           return ''
       clean_uuid = uuid_str.split('-')[0].lower()
       return clean_uuid[:8] if clean_uuid else ''
   ```

2. **Endpoint de redirección**: La ruta `/api/usuario/<uuid_segment>` permite encontrar un usuario a partir del segmento de 8 caracteres y redirigir a su perfil completo.

3. **Generación de URL compartible**: Ya se está generando una URL compartible en la ruta `/buscar` cuando se visualiza un perfil de usuario.

## Diseño del Módulo QR_code con segno

### Estructura Propuesta

```
meli_supa_test/
├── qr_code/
│   ├── __init__.py
│   ├── generator.py     # Funcionalidad de generación de QR con segno
│   └── routes.py        # Rutas específicas para QR (si son necesarias)
```

### Algoritmo de Generación de QR

El algoritmo para la generación de códigos QR utilizando segno seguirá estos pasos:

1. **Obtención del segmento UUID**: Utilizando el método `get_uuid_segment()` ya existente.
2. **Generación de URL**: Crear una URL que apunte a `/api/usuario/<uuid_segment>`.
3. **Generación del código QR**: Utilizar la biblioteca `segno` para generar el código QR a partir de la URL.
4. **Almacenamiento o presentación**: Devolver el código QR como imagen PNG para su inclusión en la interfaz web.

```python
import segno

def generate_qr_for_user(user_id, navegador, scale=5, format="png"):
    """
    Genera un código QR para un usuario basado en su ID.
    
    Args:
        user_id: ID del usuario
        navegador: Instancia de NavegadorSupabase
        scale: Factor de escala del QR (tamaño)
        format: Formato de salida ('png', 'svg', 'base64')
        
    Returns:
        Código QR en el formato especificado
    """
    # 1. Obtener el segmento UUID
    uuid_segment = navegador.get_uuid_segment(user_id)
    
    if not uuid_segment:
        return None
    
    # 2. Generar la URL
    url = f"{BASE_URL}/api/usuario/{uuid_segment}"
    
    # 3. Generar el código QR con segno (una sola línea)
    qr = segno.make(url, error='m')
    
    # 4. Devolver en el formato requerido
    if format == "png":
        return qr.png_bytes(scale=scale)
    elif format == "svg":
        return qr.svg_bytes(scale=scale)
    elif format == "base64":
        import base64
        png_data = qr.png_bytes(scale=scale)
        return f"data:image/png;base64,{base64.b64encode(png_data).decode()}"
    else:
        return qr  # Devolver el objeto QR para manipulación adicional
```

### Integración con el Mecanismo Existente

La clave de este enfoque es que **no se duplica la lógica de redirección**. El código QR simplemente apunta al endpoint existente `/api/usuario/<uuid_segment>`, y este se encarga de:

1. Validar el segmento UUID
2. Buscar el usuario correspondiente
3. Redirigir al perfil completo

## Plan de Implementación

### Fase 1: Preparación

1. Instalar dependencia segno:
   ```
   pip install segno
   ```
   Agregar esta dependencia a `requirements.txt`

2. Crear la estructura de directorios para el módulo:
   ```
   mkdir -p qr_code
   touch qr_code/__init__.py qr_code/generator.py
   ```

### Fase 2: Implementación Básica

1. **Implementar el generador de QR** en `qr_code/generator.py` utilizando segno:
   - Crear la clase `QRGenerator` con métodos para generar códigos QR
   - Aprovechar la simplicidad y eficiencia de segno para múltiples formatos de salida
   - Asegurar que la URL generada use el mecanismo de segmento UUID existente

2. **Integrar con el módulo principal** modificando `app.py`:
   - Importar el módulo `qr_code`
   - Agregar un endpoint para solicitar códigos QR si es necesario

### Fase 3: Mejoras y Optimización

1. **Implementar caché** para códigos QR frecuentemente solicitados
   - Evitar regenerar QR para los mismos usuarios repetidamente
   - Usar un sistema simple de caché en memoria o Redis si está disponible

2. **Personalización de códigos QR**
   - Aprovechar las capacidades de personalización de segno
   - Opcionalmente, agregar un logo en el centro del QR para branding

### Fase 4: Integración en la Interfaz de Usuario

1. **Integrar en la plantilla de perfil** de usuario:
   - Agregar botón "Generar QR" bajo la tabla de "datos de cuenta" en la sección de información de usuario
   - El código QR se generará y mostrará SOLO al presionar este botón (no automáticamente)
   - Colocar un botón "Guardar QR" junto al anterior para permitir descargar la imagen generada

2. **Implementar la interacción con JavaScript**:
   - Gestionar el evento de clic en "Generar QR"
   - Realizar la petición AJAX al endpoint de generación de QR
   - Mostrar el resultado como imagen junto a los botones
   - Implementar la funcionalidad de descarga para el botón "Guardar QR"

3. **Agregar funcionalidad en la API JSON**:
   - Endpoint para solicitar el código QR en formato JSON con Base64
   - Permitir integración en aplicaciones externas

## Implementación Concreta con segno

### qr_code/generator.py
```python
import segno
import base64
from io import BytesIO
from flask import current_app, url_for

class QRGenerator:
    def __init__(self, base_url=None):
        """
        Inicializa el generador de QR.
        
        Args:
            base_url: URL base para la redirección (opcional)
        """
        self.base_url = base_url
    
    def _get_user_url(self, uuid_segment):
        """Genera la URL para redirección del usuario."""
        if self.base_url:
            return f"{self.base_url}/api/usuario/{uuid_segment}"
        else:
            # Usar url_for si estamos en un contexto Flask
            return url_for('get_usuario_by_uuid_segment', 
                          uuid_segment=uuid_segment, 
                          _external=True)
    
    def generate_qr(self, user_id, navegador_supabase, scale=5, error_level='m'):
        """
        Genera un código QR para un usuario utilizando segno.
        
        Args:
            user_id: ID del usuario
            navegador_supabase: Instancia de NavegadorSupabase para obtener el segmento UUID
            scale: Factor de escala para el tamaño del QR
            error_level: Nivel de corrección de errores ('l', 'm', 'q', 'h')
            
        Returns:
            Objeto de QR de segno
        """
        # Extraer el segmento UUID usando el navegador
        uuid_segment = navegador_supabase.get_uuid_segment(user_id)
        
        if not uuid_segment:
            return None
            
        # Generar la URL
        url = self._get_user_url(uuid_segment)
        
        # Generar el código QR con una sola línea de código
        qr = segno.make(url, error=error_level)
        return qr
    
    def generate_qr_png(self, user_id, navegador_supabase, scale=5):
        """
        Genera un código QR en formato PNG.
        
        Args:
            user_id: ID del usuario
            navegador_supabase: Instancia de NavegadorSupabase
            scale: Factor de escala
            
        Returns:
            Bytes de la imagen PNG
        """
        qr = self.generate_qr(user_id, navegador_supabase)
        if not qr:
            return None
        return qr.png_bytes(scale=scale)
    
    def save_qr(self, user_id, navegador_supabase, filename, scale=5):
        """
        Guarda un código QR en un archivo utilizando segno.
        
        Args:
            user_id: ID del usuario
            navegador_supabase: Instancia de NavegadorSupabase
            filename: Ruta donde guardar el archivo
            scale: Factor de escala
            
        Returns:
            True si se guardó correctamente, False en caso contrario
        """
        qr = self.generate_qr(user_id, navegador_supabase)
        
        if not qr:
            return False
            
        try:
            # segno permite guardar directamente en múltiples formatos
            qr.save(filename, scale=scale)
            return True
        except Exception:
            return False
```

### Integración en app.py
```python
from qr_code.generator import QRGenerator

# Inicializar el generador de QR
qr_generator = QRGenerator()

@app.route('/api/usuario/<uuid_segment>/qr')
def get_user_qr(uuid_segment):
    """
    Genera un código QR para un usuario a partir de su segmento UUID.
    
    GET /api/usuario/550e8400/qr -> Devuelve un código QR que redirige al usuario con ID que comience con 550e8400
    """
    try:
        # Validar el formato del segmento UUID
        if not uuid_segment or len(uuid_segment) != 8:
            return jsonify({"error": "Formato de segmento UUID inválido. Debe tener 8 caracteres."}), 400
        
        # Encontrar el usuario completo primero
        response = db.client.table('usuarios').select('id').execute()
        matching_users = [user for user in response.data 
                         if user.get('id', '').lower().startswith(uuid_segment)]
        
        if not matching_users:
            return jsonify({"error": f"No se encontró ningún usuario con el ID que comience con {uuid_segment}"}), 404
        
        # Obtener el ID completo
        user_id = matching_users[0]['id']
        
        # Determinar el formato de respuesta
        format_type = request.args.get('format', 'json')
        scale = request.args.get('scale', 5, type=int)
        
        if format_type == 'json':
            # Generar QR en formato Base64
            qr_base64 = qr_generator.generate_qr_base64(user_id, navegador, scale=scale)
            return jsonify({
                "success": True,
                "qr_code": qr_base64,
                "uuid_segment": uuid_segment
            })
        elif format_type == 'svg':
            # Devolver SVG
            svg = qr_generator.generate_qr_svg(user_id, navegador, scale=scale)
            return Response(svg, mimetype='image/svg+xml')
        else:
            # Devolver la imagen PNG directamente
            png_data = qr_generator.generate_qr_png(user_id, navegador, scale=scale)
            return Response(png_data, mimetype='image/png')
            
    except Exception as e:
        logger.error(f"Error al generar QR para el usuario {uuid_segment}: {str(e)}", exc_info=True)
        return jsonify({"error": "Error interno del servidor"}), 500
```

## Ventajas de segno sobre otras bibliotecas

1. **Rendimiento superior**: segno es 10-100 veces más rápido que otras bibliotecas como qrcode
2. **Cumplimiento de estándares**: Implementa completamente las especificaciones ISO/IEC 18004:2015
3. **Tamaño optimizado**: Genera los códigos QR más pequeños posibles para un dato específico
4. **Cero dependencias externas**: Funciona sin requerir otras bibliotecas
5. **Múltiples formatos**: Soporta PNG, SVG, EPS, PDF, TXT, ANSI y otros
6. **Memoria eficiente**: Utiliza menos recursos durante la generación
7. **API simple**: Una sola línea `segno.make()` para casos de uso básicos

## Implementación de la Interfaz de Usuario

A continuación se detalla la implementación de la interfaz de usuario para la generación y descarga de códigos QR:

### Integración en la plantilla buscar.html

El siguiente código debe insertarse en el template `buscar.html`, específicamente bajo la tabla de "datos de cuenta" en la sección de información de usuario:

```html
<!-- Sección de Código QR - Colocar bajo la tabla de datos de cuenta -->
<div class="mt-6 qr-code-section">
  <h4 class="text-lg font-semibold">Código QR de Usuario</h4>
  <p class="text-sm text-gray-600 mb-2">Acceso rápido al perfil mediante escaneo</p>
  
  <!-- Contenedor para el QR (inicialmente oculto) -->
  <div id="qrCodeContainer" class="hidden py-3">
    <img id="qrCodeImage" class="border border-gray-300 p-2 mb-2 max-w-xs" alt="Código QR de usuario">
  </div>
  
  <!-- Botones de acción -->
  <div class="flex space-x-3">
    <!-- Botón Generar QR -->
    <button id="generateQRBtn" 
            data-uuid="{{ user_id }}" 
            class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded">
      Generar QR
    </button>
    
    <!-- Botón Guardar QR (inicialmente oculto) -->
    <a id="saveQRBtn" 
       class="hidden bg-green-500 hover:bg-green-700 text-white font-bold py-2 px-4 rounded cursor-pointer">
      Guardar QR
    </a>
  </div>
</div>
```

### JavaScript para la funcionalidad de los botones

El siguiente código JavaScript debe agregarse al final de la plantilla para gestionar la interacción con los botones:

```html
<!-- JavaScript para manejo de generación y descarga de códigos QR -->
<script>
document.addEventListener('DOMContentLoaded', function() {
  // Referencias a elementos DOM
  const generateQRBtn = document.getElementById('generateQRBtn');
  const saveQRBtn = document.getElementById('saveQRBtn');
  const qrCodeContainer = document.getElementById('qrCodeContainer');
  const qrCodeImage = document.getElementById('qrCodeImage');
  
  // Solo proceder si el botón existe en la página
  if (generateQRBtn) {
    // Configurar el evento para generar el QR
    generateQRBtn.addEventListener('click', function() {
      // Obtener UUID del atributo data-uuid
      const userId = this.getAttribute('data-uuid');
      // Extraer segmento UUID (primeros 8 caracteres)
      const uuidSegment = userId.toLowerCase().split('-')[0].substring(0, 8);
      
      // Mostrar indicador de carga
      generateQRBtn.textContent = 'Generando...';
      generateQRBtn.disabled = true;
      
      // Llamar al endpoint para generar QR
      fetch(`/api/usuario/${uuidSegment}/qr?format=json`)
        .then(response => response.json())
        .then(data => {
          if (data.success && data.qr_code) {
            // Mostrar el QR generado
            qrCodeImage.src = data.qr_code;
            qrCodeContainer.classList.remove('hidden');
            saveQRBtn.classList.remove('hidden');
            
            // Configurar el botón de descarga
            saveQRBtn.href = data.qr_code;
            saveQRBtn.download = `qr_usuario_${uuidSegment}.png`;
            
            // Actualizar texto del botón
            generateQRBtn.textContent = 'Regenerar QR';
          } else {
            alert('Error al generar el código QR: ' + (data.error || 'Error desconocido'));
          }
        })
        .catch(error => {
          console.error('Error:', error);
          alert('Error al comunicarse con el servidor');
        })
        .finally(() => {
          // Restaurar botón a estado normal
          generateQRBtn.disabled = false;
        });
    });
  }
});
</script>
```

### Consideraciones de Diseño y Experiencia de Usuario

1. **Flujo de interacción**:
   - El usuario visita el perfil de un apicultor/usuario
   - Presiona el botón "Generar QR" bajo la tabla de datos de cuenta
   - El código QR aparece junto a los botones
   - Opcionalmente, puede presionar "Guardar QR" para descargar la imagen

2. **Accesibilidad**:
   - El botón "Generar QR" está visible para todos los usuarios
   - Los estados de carga y error están claramente comunicados
   - Los botones siguen los estándares de diseño de la aplicación

3. **Rendimiento**:
   - El código QR se genera bajo demanda para evitar carga innecesaria
   - No se almacena permanentemente, lo que ahorra espacio en el servidor
   - El formato Base64 permite una visualización inmediata sin recargar la página

## Conclusión

La implementación del módulo QR_code utilizando segno proporciona una solución eficiente, rápida y estandarizada para la generación de códigos QR vinculados a usuarios en la aplicación. Al reutilizar el mecanismo existente de UUIDs, se mantiene la consistencia y se evita la duplicación de código.

La interfaz de usuario ha sido diseñada para ser simple y centrada en el usuario, permitiendo generar códigos QR bajo demanda con un simple clic y ofreciendo la opción (no obligatoria) de guardar el código generado.

Segno es la elección ideal para este proyecto, ya que ofrece rendimiento óptimo, cumplimiento de estándares internacionales y una API simple que simplifica enormemente el código necesario para la generación de códigos QR.
