{% extends "base/layout.html" %}

{% block title %}Editar Perfil - MeliAPP{% endblock %}

{% block content %}
<div class="min-h-screen bg-gradient-to-br from-amber-50 to-orange-100 py-8">
    <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8">
        <!-- Header -->
        <div class="bg-white rounded-xl shadow-lg mb-6">
            <div class="px-6 py-4 border-b border-gray-200">
                <div class="flex items-center justify-between">
                    <div>
                        <h1 class="text-2xl font-bold text-gray-900"> Editar Informaci贸n Personal</h1>
                        <p class="text-sm text-gray-600 mt-1">Actualiza tus datos personales de forma segura</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tab Navigation -->
        <div class="bg-white rounded-xl shadow-lg mb-6">
            <div class="px-6 py-4">
                <nav class="flex space-x-8 border-b border-gray-200">
                    <button onclick="showTab('usuarios')" id="tab-usuarios" class="tab-btn py-3 px-1 border-b-2 border-amber-500 text-amber-600 font-medium">
                        <i class="fas fa-user mr-2"></i>Usuario
                    </button>
                    <button onclick="showTab('info_contacto')" id="tab-info_contacto" class="tab-btn py-3 px-1 border-b-2 border-transparent text-gray-500 hover:text-gray-700">
                        <i class="fas fa-address-card mr-2"></i>Contacto
                    </button>
                    <button onclick="showTab('ubicaciones')" id="tab-ubicaciones" class="tab-btn py-3 px-1 border-b-2 border-transparent text-gray-500 hover:text-gray-700">
                        <i class="fas fa-map-marker-alt mr-2"></i>Ubicaci贸n
                    </button>
                </nav>
            </div>
        </div>

        <!-- Forms Container -->
        <div class="bg-white rounded-xl shadow-lg">
            <div class="px-6 py-8">
                
                <!-- USUARIOS FORM -->
                <div id="form-usuarios" class="tab-content">
                    <div class="mb-6">
                        <h3 class="text-lg font-semibold text-gray-900 mb-2">Datos de Usuario</h3>
                        <p class="text-sm text-gray-600">Edita tu username y rol. El tipo de usuario siempre es "Regular".</p>
                    </div>
                    
                    <form onsubmit="submitForm(event, 'usuarios')" class="space-y-6">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <!-- Username -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                    Username *
                                    <span class="text-xs text-gray-500">(3-80 caracteres, solo letras, n煤meros, - y _)</span>
                                </label>
                                <input type="text" 
                                       name="username" 
                                       id="usuarios-username" 
                                       class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-amber-500 focus:border-amber-500"
                                       minlength="3" 
                                       maxlength="80" 
                                       pattern="^[a-zA-Z0-9_-]+$"
                                       required>
                            </div>
                            
                            <!-- Tipo Usuario (readonly) -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Tipo de Usuario</label>
                                <input type="text" 
                                       value="Regular" 
                                       readonly 
                                       class="w-full px-3 py-2 border border-gray-300 rounded-md bg-gray-100 text-gray-600 cursor-not-allowed">
                                <p class="text-xs text-gray-500 mt-1">Siempre "Regular" para usuarios registrados</p>
                            </div>
                        </div>
                        
                        <!-- Role -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Rol *</label>
                            <select name="role" 
                                    id="usuarios-role" 
                                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-amber-500 focus:border-amber-500"
                                    required>
                                <option value="APICULTOR">APICULTOR</option>
                                <option value="PROVEEDOR">PROVEEDOR</option>
                                <option value="PRESTADOR DE SERVICIOS">PRESTADOR DE SERVICIOS</option>
                            </select>
                        </div>
                        
                        <button type="submit" class="w-full bg-amber-500 hover:bg-amber-600 text-white font-medium py-3 px-4 rounded-lg transition-colors">
                            <i class="fas fa-save mr-2"></i>Guardar Datos de Usuario
                        </button>
                    </form>
                </div>

                <!-- INFO_CONTACTO FORM -->
                <div id="form-info_contacto" class="tab-content hidden">
                    <div class="mb-6">
                        <h3 class="text-lg font-semibold text-gray-900 mb-2">Informaci贸n de Contacto</h3>
                        <p class="text-sm text-gray-600">Actualiza tu informaci贸n de contacto personal y empresarial.</p>
                    </div>
                    
                    <form onsubmit="submitForm(event, 'info_contacto')" class="space-y-6">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <!-- Nombre Completo -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                    Nombre Completo
                                    <span class="text-xs text-gray-500">(2-150 caracteres)</span>
                                </label>
                                <input type="text" 
                                       name="nombre_completo" 
                                       id="contacto-nombre_completo" 
                                       class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-amber-500 focus:border-amber-500"
                                       minlength="2" 
                                       maxlength="150"
                                       placeholder="Juan P茅rez Gonz谩lez">
                            </div>
                            
                            <!-- Nombre Empresa -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Nombre Empresa</label>
                                <input type="text" 
                                       name="nombre_empresa" 
                                       id="contacto-nombre_empresa" 
                                       class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-amber-500 focus:border-amber-500"
                                       placeholder="Mi Empresa Ap铆cola">
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <!-- Correo Principal -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Correo Principal</label>
                                <input type="email" 
                                       name="correo_principal" 
                                       id="contacto-correo_principal" 
                                       class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-amber-500 focus:border-amber-500"
                                       placeholder="tu@email.com">
                            </div>
                            
                            <!-- Tel茅fono Principal -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Tel茅fono Principal</label>
                                <input type="tel" 
                                       name="telefono_principal" 
                                       id="contacto-telefono_principal" 
                                       class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-amber-500 focus:border-amber-500"
                                       placeholder="+56 9 1234 5678">
                            </div>
                        </div>
                        
                        <!-- Direcci贸n -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Direcci贸n</label>
                            <input type="text" 
                                   name="direccion" 
                                   id="contacto-direccion" 
                                   class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-amber-500 focus:border-amber-500"
                                   placeholder="Av. Principal 123, Depto 4B">
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <!-- Comuna -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Comuna</label>
                                <input type="text" 
                                       name="comuna" 
                                       id="contacto-comuna" 
                                       class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-amber-500 focus:border-amber-500"
                                       placeholder="Las Condes">
                            </div>
                            
                            <!-- Regi贸n -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Regi贸n</label>
                                <input type="text" 
                                       name="region" 
                                       id="contacto-region" 
                                       class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-amber-500 focus:border-amber-500"
                                       placeholder="Regi贸n Metropolitana">
                            </div>
                        </div>
                        
                        <button type="submit" class="w-full bg-amber-500 hover:bg-amber-600 text-white font-medium py-3 px-4 rounded-lg transition-colors">
                            <i class="fas fa-save mr-2"></i>Guardar Informaci贸n de Contacto
                        </button>
                    </form>
                </div>

                <!-- UBICACIONES FORM -->
                <div id="form-ubicaciones" class="tab-content hidden">
                    <div class="mb-6">
                        <h3 class="text-lg font-semibold text-gray-900 mb-2">Ubicaci贸n</h3>
                        <p class="text-sm text-gray-600">Agrega una nueva ubicaci贸n. Se reemplazar谩 la ubicaci贸n anterior.</p>
                    </div>
                    
                    <!-- Instrucciones -->
                    <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6">
                        <div class="flex items-center justify-between">
                            <div>
                                <h3 class="text-lg font-semibold text-gray-900 mb-2">Mis Ubicaciones</h3>
                                <p class="text-sm text-gray-600">Gestiona tus ubicaciones de colmenares</p>
                            </div>
                            <div class="flex space-x-3">
                                <button onclick="showAddLocationForm()" class="bg-amber-600 text-white px-4 py-2 rounded-md hover:bg-amber-700">
                                    <i class="fas fa-plus mr-2"></i>Nueva Ubicaci贸n
                                </button>
                                <button onclick="showDeleteLocationForm()" class="bg-red-600 text-white px-4 py-2 rounded-md hover:bg-red-700">
                                    <i class="fas fa-trash mr-2"></i>Eliminar Ubicaci贸n
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Lista de ubicaciones existentes -->
                    <div id="ubicaciones-list" class="mb-6">
                        <div class="text-center py-8 text-gray-500">
                            <i class="fas fa-map-marker-alt text-4xl mb-2"></i>
                            <p>Cargando ubicaciones...</p>
                        </div>
                    </div>
                                       
                    <!-- Formulario para agregar/editar ubicaci贸n -->
                    <div id="ubicacion-form-container" class="hidden bg-gray-50 p-6 rounded-lg">
                        <div class="flex justify-between items-center mb-4">
                            <h4 id="ubicacion-form-title" class="text-md font-semibold">Agregar Nueva Ubicaci贸n</h4>
                            <button onclick="hideAddLocationForm()" class="text-gray-500 hover:text-gray-700">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        
                        <form id="ubicacion-form" class="space-y-6">
                            <input type="hidden" name="id" id="ubicaciones-id">
                            
                            <!-- Plus Code -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Google Maps Plus Code *</label>
                                <input type="text" 
                                       name="gmaps_plus_code" 
                                       id="ubicaciones-gmaps_plus_code" 
                                       class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-amber-500 focus:border-amber-500"
                                       placeholder="6RXC+Q7C Colluqueo, Lonquimay"
                                       required>
                                <p class="text-xs text-gray-500 mt-1">Ejemplo: 6RXC+Q7C Colluqueo, Lonquimay</p>
                            </div>
                            
                            <!-- Nombre de ubicaci贸n -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Nombre de la ubicaci贸n *</label>
                                <input type="text" 
                                       name="nombre" 
                                       id="ubicaciones-nombre" 
                                       class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-amber-500 focus:border-amber-500"
                                       placeholder="Colmenar Principal - Colluqueo, Lonquimay"
                                       required>
                            </div>
                            
                            <!-- Latitud (oculto) -->
                            <input type="hidden" name="latitud" id="ubicaciones-latitud">
                            
                            <!-- Longitud (oculto) -->
                            <input type="hidden" name="longitud" id="ubicaciones-longitud">
                            
                            <!-- Descripci贸n -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Descripci贸n</label>
                                <textarea name="descripcion" 
                                          id="ubicaciones-descripcion" 
                                          class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-amber-500 focus:border-amber-500"
                                          placeholder="Descripci贸n adicional de la ubicaci贸n"
                                          rows="3"></textarea>
                            </div>
                            
                            <div class="flex space-x-3">
                                <button type="submit" 
                                        onclick="submitUbicacionForm(event)" 
                                        class="flex-1 bg-amber-600 text-white py-2 px-4 rounded-md hover:bg-amber-700 focus:outline-none focus:ring-2 focus:ring-amber-500 focus:ring-offset-2">
                                    <i class="fas fa-save mr-2"></i><span id="ubicacion-submit-text">Guardar Ubicaci贸n</span>
                                </button>
                                <button type="button" 
                                        onclick="hideAddLocationForm()" 
                                        class="px-4 py-2 border border-gray-300 rounded-md text-gray-700 hover:bg-gray-50">
                                    Cancelar
                                </button>
                            </div>
                        </form>
                    </div>
                    
                    <!-- Formulario para eliminar ubicaci贸n -->
                    <div id="delete-location-form-container" class="hidden bg-red-50 p-6 rounded-lg border border-red-200">
                        <div class="flex justify-between items-center mb-4">
                            <h4 class="text-md font-semibold text-red-800">Eliminar Ubicaci贸n</h4>
                            <button onclick="hideDeleteLocationForm()" class="text-gray-500 hover:text-gray-700">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        
                        <div class="mb-4">
                            <p class="text-sm text-red-600 mb-4">Selecciona la ubicaci贸n que deseas eliminar. Esta acci贸n no se puede deshacer.</p>
                            <select id="delete-location-select" class="w-full px-3 py-2 border border-red-300 rounded-md focus:outline-none focus:ring-2 focus:ring-red-500">
                                <option value="">Selecciona una ubicaci贸n...</option>
                            </select>
                        </div>
                        
                        <div class="flex justify-end space-x-3">
                            <button type="button" 
                                    onclick="confirmDeleteLocation()" 
                                    class="px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700 disabled:opacity-50">
                                <i class="fas fa-trash mr-2"></i>Eliminar
                            </button>
                            <button type="button" 
                                    onclick="hideDeleteLocationForm()" 
                                    class="px-4 py-2 border border-gray-300 rounded-md text-gray-700 hover:bg-gray-50">
                                Cancelar
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Toast Messages -->
<div id="toast" class="fixed top-4 right-4 z-50 hidden">
    <div class="bg-white border border-gray-200 rounded-lg shadow-lg p-4 max-w-sm">
        <div class="flex items-center">
            <div id="toast-icon" class="mr-3"></div>
            <div>
                <p id="toast-message" class="text-sm font-medium text-gray-900"></p>
            </div>
        </div>
    </div>
</div>

<script>
// Tab Management
function showTab(tabName) {
    // Hide all tab contents
    document.querySelectorAll('.tab-content').forEach(content => {
        content.classList.add('hidden');
    });
    
    // Remove active styles from all tabs
    document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.classList.remove('border-amber-500', 'text-amber-600');
        btn.classList.add('border-transparent', 'text-gray-500');
    });
    
    // Show selected tab content
    document.getElementById(`form-${tabName}`).classList.remove('hidden');
    
    // Add active styles to selected tab
    const activeTab = document.getElementById(`tab-${tabName}`);
    activeTab.classList.remove('border-transparent', 'text-gray-500');
    activeTab.classList.add('border-amber-500', 'text-amber-600');
    
    // Load data for the selected tab
    loadTabData(tabName);
}

// Load existing data for a tab
async function loadTabData(tabName) {
    try {
        const response = await fetch(`/api/data/${tabName}`);
        const result = await response.json();
        
        if (result.success) {
            const data = result.data;
            
            // Store user ID globally for profile navigation - usar UUID completo
            if (tabName === 'usuarios' && data.id) {
                window.currentUserId = data.id;
                console.log('Usuario UUID completo cargado:', window.currentUserId);
            } else if (tabName === 'usuarios' && result.usuario && result.usuario.id) {
                // Fallback si viene en estructura diferente
                window.currentUserId = result.usuario.id;
                console.log('Usuario UUID completo cargado (fallback):', window.currentUserId);
            }
            
            // Populate form fields based on tab
            if (tabName === 'usuarios') {
                if (data.username) document.getElementById('usuarios-username').value = data.username || '';
                if (data.role) document.getElementById('usuarios-role').value = data.role || '';
            } else if (tabName === 'info_contacto') {
                if (data.nombre_completo) document.getElementById('contacto-nombre_completo').value = data.nombre_completo || '';
                if (data.nombre_empresa) document.getElementById('contacto-nombre_empresa').value = data.nombre_empresa || '';
                if (data.correo_principal) document.getElementById('contacto-correo_principal').value = data.correo_principal || '';
                if (data.direccion) document.getElementById('contacto-direccion').value = data.direccion || '';
                if (data.comuna) document.getElementById('contacto-comuna').value = data.comuna || '';
                if (data.region) document.getElementById('contacto-region').value = data.region || '';
                if (data.telefono_principal) document.getElementById('contacto-telefono_principal').value = data.telefono_principal || '';
            } else if (tabName === 'ubicaciones') {
                // Display all locations - usar result.ubicaciones en lugar de data
                displayUbicaciones(result.ubicaciones || []);
            }
        }
    } catch (error) {
        console.error('Error loading data:', error);
    }
}

// Form submission
async function submitForm(event, tableName) {
    event.preventDefault();
    
    const form = event.target;
    const formData = new FormData(form);
    const data = {};
    
    // Convertir FormData a objeto - incluir TODOS los campos, incluso vac铆os
    for (let [key, value] of formData.entries()) {
        data[key] = value.trim();
    }
    
    // Si no hay ning煤n campo, mostrar advertencia
    if (Object.keys(data).length === 0) {
        showToast('warning', 'No hay campos en el formulario');
        return;
    }
    
    // Verificar que al menos un campo tenga contenido
    const hasContent = Object.values(data).some(val => val && val.trim() !== '');
    if (!hasContent) {
        showToast('warning', 'Por favor ingresa al menos un valor');
        return;
    }
    
    console.log('Enviando datos:', data);
    
    try {
        const response = await fetch(`/api/edit/${tableName}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(data)
        });
        
        const result = await response.json();
        
        if (result.success) {
            showToast('success', `${tableName.charAt(0).toUpperCase() + tableName.slice(1)} actualizado exitosamente`);
            
            // Redirigir al perfil despu茅s de 2 segundos
            setTimeout(() => {
                // Usar SIEMPRE el UUID completo del usuario autenticado
                const userId = window.currentUserId;
                if (userId && userId !== 'undefined' && userId !== 'null') {
                    const fullProfileUrl = `/profile/${userId}`;
                    console.log('Redirigiendo a perfil:', fullProfileUrl);
                    window.location.href = fullProfileUrl;
                } else {
                    console.error('No se pudo obtener el UUID del usuario');
                    // Fallback: usar el UUID que viene en la respuesta
                    if (result.user_id) {
                        window.location.href = `/profile/${result.user_id}`;
                    } else if (result.id) {
                        window.location.href = `/profile/${result.id}`;
                    } else {
                        // ltimo fallback: obtener desde localStorage o session
                        const storedUserId = localStorage.getItem('currentUserId') || sessionStorage.getItem('currentUserId');
                        if (storedUserId) {
                            window.location.href = `/profile/${storedUserId}`;
                        } else {
                            console.error('No hay UUID disponible para redirecci贸n');
                        }
                    }
                }
            }, 2000);
        } else {
            showToast('error', result.error || 'Error al actualizar');
        }
    } catch (error) {
        console.error('Error:', error);
        showToast('error', 'Error al procesar la solicitud');
    }
}

// Funciones para gesti贸n de ubicaciones
function showAddLocationForm() {
    document.getElementById('ubicacion-form-container').classList.remove('hidden');
    document.getElementById('ubicacion-form-title').textContent = 'Agregar Nueva Ubicaci贸n';
    document.getElementById('ubicacion-submit-text').textContent = 'Guardar Ubicaci贸n';
    document.getElementById('ubicacion-form').reset();
    document.getElementById('ubicaciones-id').value = '';
}

function hideAddLocationForm() {
    document.getElementById('ubicacion-form-container').classList.add('hidden');
    document.getElementById('ubicacion-form').reset();
}

function editUbicacion(ubicacion) {
    document.getElementById('ubicacion-form-container').classList.remove('hidden');
    document.getElementById('ubicacion-form-title').textContent = 'Editar Ubicaci贸n';
    document.getElementById('ubicacion-submit-text').textContent = 'Actualizar Ubicaci贸n';
    
    // Llenar el formulario con los datos existentes
    document.getElementById('ubicaciones-id').value = ubicacion.id || '';
    document.getElementById('ubicaciones-gmaps_plus_code').value = ubicacion.gmaps_plus_code || '';
    document.getElementById('ubicaciones-nombre').value = ubicacion.nombre || '';
    document.getElementById('ubicaciones-latitud').value = ubicacion.latitud || '';
    document.getElementById('ubicaciones-longitud').value = ubicacion.longitud || '';
    document.getElementById('ubicaciones-descripcion').value = ubicacion.descripcion || '';
}

function displayUbicaciones(ubicaciones) {
    const container = document.getElementById('ubicaciones-list');
    
    if (!Array.isArray(ubicaciones) || ubicaciones.length === 0) {
        container.innerHTML = `
            <div class="text-center py-8 text-gray-500">
                <i class="fas fa-map-marker-alt text-4xl mb-2"></i>
                <p>No tienes ubicaciones registradas</p>
                <button onclick="showAddLocationForm()" class="mt-4 text-amber-600 hover:text-amber-700">
                    <i class="fas fa-plus mr-1"></i>Agregar primera ubicaci贸n
                </button>
            </div>
        `;
        return;
    }
    
    container.innerHTML = ubicaciones.map(ubicacion => `
        <div class="bg-white border border-gray-200 rounded-lg p-4 mb-4">
            <div class="flex justify-between items-start">
                <div class="flex-1">
                    <h4 class="font-semibold text-gray-900">${ubicacion.nombre || 'Sin nombre'}</h4>
                    <p class="text-sm text-gray-600 mt-1">${ubicacion.descripcion || 'Sin descripci贸n'}</p>
                    <div class="mt-2">
                        <span class="text-xs bg-gray-100 text-gray-700 px-2 py-1 rounded">${ubicacion.gmaps_plus_code}</span>
                        <a href="https://maps.google.com/?q=${ubicacion.latitud},${ubicacion.longitud}" 
                           target="_blank" 
                           class="text-xs text-amber-600 hover:text-amber-700 ml-2">
                            <i class="fas fa-external-link-alt mr-1"></i>Ver en Maps
                        </a>
                    </div>
                </div>
                <div class="flex space-x-2 ml-4">
                    <button onclick='editUbicacion(${JSON.stringify(ubicacion).replace(/'/g, "&apos;")})' 
                            class="text-blue-600 hover:text-blue-800 p-1">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button onclick='deleteUbicacion("${ubicacion.id}")' 
                            class="text-red-600 hover:text-red-800 p-1">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>
        </div>
    `).join('');
}

async function deleteUbicacion(id) {
    if (!confirm('驴Est谩s seguro de eliminar esta ubicaci贸n?')) return;
    
    try {
        const response = await fetch('/api/edit/ubicaciones', {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ id })
        });
        
        const result = await response.json();
        if (result.success) {
            showToast('Ubicaci贸n eliminada exitosamente', 'success');
            loadTabData('ubicaciones');
        } else {
            showToast('Error: ' + result.error, 'error');
        }
    } catch (error) {
        console.error('Error:', error);
        showToast('Error al eliminar ubicaci贸n', 'error');
    }
}

// Funci贸n actualizada para enviar formulario de ubicaciones
async function submitUbicacionForm(event) {
    event.preventDefault();
    
    const form = document.getElementById('ubicacion-form');
    const formData = new FormData(form);
    
    // Convertir FormData a objeto
    const data = {};
    formData.forEach((value, key) => {
        data[key] = value;
    });
    
    // Limpiar Plus Code (remover texto adicional)
    if (data.gmaps_plus_code) {
        // Extraer solo el Plus Code (ej: "6RXC+Q7C" de "6RXC+Q7C Colluqueo")
        const plusCodeMatch = data.gmaps_plus_code.match(/([23456789CFGHJMPQRVWX]{8,}[+]?[23456789CFGHJMPQRVWX]{2,})/i);
        if (plusCodeMatch) {
            data.gmaps_plus_code = plusCodeMatch[1].toUpperCase();
        }
    }
    
    console.log(' Enviando datos:', data);
    
    // Determinar m茅todo HTTP seg煤n si es edici贸n o creaci贸n
    const method = data.id ? 'PUT' : 'POST';
    
    // Enviar al backend
    fetch('/api/edit/ubicaciones', {
        method: method,
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(result => {
        console.log(' Respuesta:', result);
        if (result.success) {
            showToast('Ubicaci贸n guardada exitosamente', 'success');
            hideAddLocationForm();
            loadTabData('ubicaciones');
            form.reset();
        } else {
            showToast('Error: ' + result.error, 'error');
        }
    })
    .catch(error => {
        console.error(' Error:', error);
        showToast('Error al guardar ubicaci贸n', 'error');
    });
}

// Toast notifications
function showToast(message, type = 'info') {
    const toast = document.getElementById('toast');
    const icon = document.getElementById('toast-icon');
    const messageEl = document.getElementById('toast-message');
    
    // Initialize on page load
    document.addEventListener('DOMContentLoaded', function() {
        // Show first tab by default
        showTab('usuarios');
        
        // Bot贸n usando UUID real del usuario (pasado desde Flask)
        const backButton = document.getElementById('backToProfile');
        if (backButton) {
            backButton.addEventListener('click', function(e) {
                e.preventDefault();
                
                // Usar el user_id pasado desde Flask
                const userId = '{{ user_id }}';
                if (userId && userId !== 'None') {
                    window.location.href = `/profile/${userId}`;
                } else {
                    // Fallback a obtener desde el backend si no est谩 disponible
                    fetch('/api/user/current')
                        .then(response => response.json())
                        .then(data => {
                            if (data.success && data.user_id) {
                                window.location.href = `/profile/${data.user_id}`;
                            } else {
                                window.location.href = '/';
                            }
                        })
                        .catch(() => {
                            window.location.href = '/';
                        });
                }
            });
        }
    });

    // Set icon and colors based on type
    if (type === 'success') {
        icon.innerHTML = '<i class="fas fa-check-circle text-green-500"></i>';
        toast.querySelector('div').classList.add('border-green-200');
    } else if (type === 'error') {
        icon.innerHTML = '<i class="fas fa-exclamation-circle text-red-500"></i>';
        toast.querySelector('div').classList.add('border-red-200');
    } else {
        icon.innerHTML = '<i class="fas fa-info-circle text-blue-500"></i>';
        toast.querySelector('div').classList.add('border-blue-200');
    }
    
    messageEl.textContent = message;
    toast.classList.remove('hidden');
    
    // Auto hide after 5 seconds
    setTimeout(() => {
        toast.classList.add('hidden');
        // Reset classes
        toast.querySelector('div').classList.remove('border-green-200', 'border-red-200', 'border-blue-200');
    }, 5000);
}

// Mostrar formulario de agregar ubicaci贸n
function showAddLocationForm() {
    document.getElementById('ubicacion-form-container').classList.remove('hidden');
    document.getElementById('delete-location-form-container').classList.add('hidden');
}

// Ocultar formulario de agregar ubicaci贸n
function hideAddLocationForm() {
    document.getElementById('ubicacion-form-container').classList.add('hidden');
}

// Mostrar formulario de eliminar ubicaci贸n
function showDeleteLocationForm() {
    document.getElementById('delete-location-form-container').classList.remove('hidden');
    document.getElementById('ubicacion-form-container').classList.add('hidden');
    loadLocationOptions();
}

// Ocultar formulario de eliminar ubicaci贸n
function hideDeleteLocationForm() {
    document.getElementById('delete-location-form-container').classList.add('hidden');
}

// Cargar opciones de ubicaciones para eliminar
async function loadLocationOptions() {
    try {
        const response = await fetch('/api/data/ubicaciones');
        const result = await response.json();
        
        const select = document.getElementById('delete-location-select');
        select.innerHTML = '<option value="">Selecciona una ubicaci贸n...</option>';
        
        if (result.success && result.ubicaciones && result.ubicaciones.length > 0) {
            result.ubicaciones.forEach(ubicacion => {
                const option = document.createElement('option');
                option.value = ubicacion.id;
                option.textContent = `${ubicacion.nombre} (${ubicacion.latitud}, ${ubicacion.longitud})`;
                select.appendChild(option);
            });
        } else {
            const option = document.createElement('option');
            option.value = '';
            option.textContent = 'No hay ubicaciones para eliminar';
            option.disabled = true;
            select.appendChild(option);
        }
    } catch (error) {
        console.error('Error cargando ubicaciones:', error);
        showToast('Error cargando ubicaciones', 'error');
    }
}

// Confirmar eliminaci贸n de ubicaci贸n
async function confirmDeleteLocation() {
    const select = document.getElementById('delete-location-select');
    const locationId = select.value;
    
    if (!locationId) {
        showToast('Por favor selecciona una ubicaci贸n', 'error');
        return;
    }
    
    if (!confirm('驴Est谩s seguro de que deseas eliminar esta ubicaci贸n? Esta acci贸n no se puede deshacer.')) {
        return;
    }
    
    try {
        const response = await fetch('/api/edit/ubicaciones', {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ id: locationId })
        });
        
        const result = await response.json();
        
        if (result.success) {
            showToast('Ubicaci贸n eliminada correctamente', 'success');
            hideDeleteLocationForm();
            // Recargar la lista de ubicaciones
            loadTabData('ubicaciones');
        } else {
            showToast(result.error || 'Error eliminando ubicaci贸n', 'error');
        }
    } catch (error) {
        console.error('Error eliminando ubicaci贸n:', error);
        showToast('Error eliminando ubicaci贸n', 'error');
    }
}

// Mostrar ubicaciones en la lista
function displayUbicaciones(ubicaciones) {
    const container = document.getElementById('ubicaciones-list');
    
    if (!ubicaciones || ubicaciones.length === 0) {
        container.innerHTML = `
            <div class="text-center py-8 text-gray-500">
                <i class="fas fa-map-marker-alt text-4xl mb-2"></i>
                <p>No hay ubicaciones registradas</p>
            </div>
        `;
        return;
    }
    
    container.innerHTML = ubicaciones.map(ubicacion => `
        <div class="bg-white border border-gray-200 rounded-lg p-4 mb-3">
            <div class="flex justify-between items-start">
                <div>
                    <h4 class="font-semibold text-gray-900">${ubicacion.nombre}</h4>
                    <p class="text-sm text-gray-600">Lat: ${ubicacion.latitud}, Lng: ${ubicacion.longitud}</p>
                    ${ubicacion.descripcion ? `<p class="text-sm text-gray-500 mt-1">${ubicacion.descripcion}</p>` : ''}
                </div>
                <div class="text-xs text-gray-400">
                    ${ubicacion.norma_geo || 'WGS84'}
                </div>
            </div>
        </div>
    `).join('');
}

// Navigate to profile using already loaded user ID
function goToProfile() {
    if (window.currentUserId) {
        window.location.href = `/profile/${window.currentUserId}`;
    } else {
        window.location.href = '/profile';
    }
}
</script>
{% endblock %}
