{% extends "base/layout.html" %}

{% block title %}Editar Perfil - MeliAPP{% endblock %}

{% block content %}
<div class="min-h-screen bg-gradient-to-br from-amber-50 to-orange-100 py-8">
    <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8">
        <!-- Header -->
        <div class="bg-white rounded-xl shadow-lg mb-6">
            <div class="px-6 py-4 border-b border-gray-200">
                <div class="flex items-center justify-between">
                    <div>
                        <h1 class="text-2xl font-bold text-gray-900"> Editar Informaci贸n Personal</h1>
                        <p class="text-sm text-gray-600 mt-1">Actualiza tus datos personales de forma segura</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tab Navigation -->
        <div class="bg-white rounded-xl shadow-lg mb-6">
            <div class="px-6 py-4">
                <nav class="flex space-x-8 border-b border-gray-200">
                    <button onclick="showTab('usuarios')" id="tab-usuarios" class="tab-btn py-3 px-1 border-b-2 border-amber-500 text-amber-600 font-medium">
                        <i class="fas fa-user mr-2"></i>Usuario
                    </button>
                    <button onclick="showTab('info_contacto')" id="tab-info_contacto" class="tab-btn py-3 px-1 border-b-2 border-transparent text-gray-500 hover:text-gray-700">
                        <i class="fas fa-address-card mr-2"></i>Contacto
                    </button>
                    <button onclick="showTab('ubicaciones')" id="tab-ubicaciones" class="tab-btn py-3 px-1 border-b-2 border-transparent text-gray-500 hover:text-gray-700">
                        <i class="fas fa-map-marker-alt mr-2"></i>Ubicaci贸n
                    </button>
                </nav>
            </div>
        </div>

        <!-- Forms Container -->
        <div class="bg-white rounded-xl shadow-lg">
            <div class="px-6 py-8">
                
                <!-- USUARIOS FORM -->
                <div id="form-usuarios" class="tab-content">
                    <div class="mb-6">
                        <h3 class="text-lg font-semibold text-gray-900 mb-2">Datos de Usuario</h3>
                        <p class="text-sm text-gray-600">Edita tu tipo de usuario. El nombre de usuario es igual al nombre completo.</p>
                    </div>
                    
                    <form onsubmit="submitForm(event, 'usuarios')" class="space-y-6">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <!-- Username (no editable) -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Nombre de Usuario</label>
                                <div class="w-full px-3 py-2 border border-gray-300 rounded-md bg-gray-50 text-gray-700" id="usuarios-username-display">
                                    <!-- Se llena autom谩ticamente con el nombre completo -->
                                </div>
                                <p class="text-xs text-gray-500 mt-1">El nombre de usuario es igual al correo sin "@DominioCorreo.com"</p>
                            </div>
                            
                            <!-- Tipo Usuario (editable) -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Tipo de Usuario *</label>
                                <select name="tipo_usuario" 
                                        id="usuarios-tipo_usuario" 
                                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-amber-500 focus:border-amber-500"
                                        required>
                                    <option value="">Seleccionar tipo...</option>
                                    <option value="apicultor"> Apicultor</option>
                                    <option value="prestador_servicios"> Prestador de Servicios</option>
                                    <option value="proveedor"> Proveedor</option>
                                    <option value="regular"> Regular</option>
                                </select>
                            </div>
                        </div>
                        
                        <!-- Role (mantener para compatibilidad) -->
                        <input type="hidden" name="role" id="usuarios-role" value="regular">
                        
                        <button type="submit" class="w-full bg-amber-500 hover:bg-amber-600 text-white font-medium py-3 px-4 rounded-lg transition-colors">
                            <i class="fas fa-save mr-2"></i>Guardar y Continuar a Contacto
                        </button>
                    </form>
                </div>

                <!-- INFO_CONTACTO FORM -->
                <div id="form-info_contacto" class="tab-content hidden">
                    <div class="mb-6">
                        <h3 class="text-lg font-semibold text-gray-900 mb-2">Informaci贸n de Contacto</h3>
                        <p class="text-sm text-gray-600">Actualiza tu informaci贸n de contacto personal y empresarial.</p>
                    </div>
                    
                    <form onsubmit="submitForm(event, 'info_contacto')" class="space-y-6">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <!-- Nombre Completo -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                    Nombre Completo
                                    <span class="text-xs text-gray-500">(2-150 caracteres)</span>
                                </label>
                                <input type="text" 
                                       name="nombre_completo" 
                                       id="contacto-nombre_completo" 
                                       class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-amber-500 focus:border-amber-500"
                                       minlength="2" 
                                       maxlength="150"
                                       placeholder="Juan P茅rez Gonz谩lez">
                            </div>
                            
                            <!-- Nombre Empresa -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Nombre Empresa</label>
                                <input type="text" 
                                       name="nombre_empresa" 
                                       id="contacto-nombre_empresa" 
                                       class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-amber-500 focus:border-amber-500"
                                       placeholder="Mi Empresa Ap铆cola">
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <!-- Correo Principal (Solo lectura) -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Correo Principal</label>
                                <div class="w-full px-3 py-2 border border-gray-300 rounded-md bg-gray-50 text-gray-700" id="contacto-correo_principal-display">
                                    <!-- Se llena autom谩ticamente desde los datos del usuario -->
                                </div>
                                <input type="hidden" name="correo_principal" id="contacto-correo_principal">
                                <p class="text-xs text-gray-500 mt-1">El correo no se puede modificar desde aqu铆</p>
                            </div>
                            
                            <!-- Tel茅fono Principal -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Tel茅fono Principal</label>
                                <input type="tel" 
                                       name="telefono_principal" 
                                       id="contacto-telefono_principal" 
                                       class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-amber-500 focus:border-amber-500"
                                       placeholder="+56 9 1234 5678">
                            </div>
                        </div>
                        
                        <!-- Direcci贸n -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Direcci贸n</label>
                            <input type="text" 
                                   name="direccion" 
                                   id="contacto-direccion" 
                                   class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-amber-500 focus:border-amber-500"
                                   placeholder="Av. Principal 123, Depto 4B">
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <!-- Comuna -->
                            <div class="relative">
                                <label class="block text-sm font-medium text-gray-700 mb-2">Comuna</label>
                                <input type="text" 
                                       name="comuna" 
                                       id="contacto-comuna" 
                                       class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-amber-500 focus:border-amber-500"
                                       placeholder="Las Condes"
                                       autocomplete="off"
                                       oninput="handleComunaInput(this)"
                                       onblur="hideSuggestions('comuna')">
                                <div id="comuna-suggestions" class="absolute z-10 w-full bg-white border border-gray-300 rounded-md shadow-lg mt-1 hidden max-h-40 overflow-y-auto">
                                    <!-- Sugerencias din谩micas -->
                                </div>
                            </div>
                            
                            <!-- Regi贸n -->
                            <div class="relative">
                                <label class="block text-sm font-medium text-gray-700 mb-2">Regi贸n</label>
                                <input type="text" 
                                       name="region" 
                                       id="contacto-region" 
                                       class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-amber-500 focus:border-amber-500"
                                       placeholder="Regi贸n Metropolitana"
                                       autocomplete="off"
                                       oninput="handleRegionInput(this)"
                                       onblur="hideSuggestions('region')">
                                <div id="region-suggestions" class="absolute z-10 w-full bg-white border border-gray-300 rounded-md shadow-lg mt-1 hidden max-h-40 overflow-y-auto">
                                    <!-- Sugerencias din谩micas -->
                                </div>
                            </div>
                        </div>
                        
                        <button type="submit" class="w-full bg-amber-500 hover:bg-amber-600 text-white font-medium py-3 px-4 rounded-lg transition-colors">
                            <i class="fas fa-save mr-2"></i>Guardar y Continuar a Ubicaci贸n
                        </button>
                    </form>
                </div>

                <!-- UBICACIONES FORM -->
                <div id="form-ubicaciones" class="tab-content hidden">
                    <div class="mb-6">
                        <h3 class="text-lg font-semibold text-gray-900 mb-2">Ubicaci贸n</h3>
                        <p class="text-sm text-gray-600">Agrega una nueva ubicaci贸n. Se reemplazar谩 la ubicaci贸n anterior.</p>
                    </div>
                    
                    <!-- Instrucciones -->
                    <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6">
                        <div class="flex items-center justify-between">
                            <div>
                                <h3 class="text-lg font-semibold text-gray-900 mb-2">Mis Ubicaciones</h3>
                                <p class="text-sm text-gray-600">Gestiona tus ubicaciones de colmenares</p>
                            </div>
                            <div class="flex space-x-3">
                                <button onclick="showAddLocationForm()" class="bg-amber-600 text-white px-4 py-2 rounded-md hover:bg-amber-700">
                                    <i class="fas fa-plus mr-2"></i>Nueva Ubicaci贸n
                                </button>
                                <button onclick="showDeleteLocationForm()" class="bg-red-600 text-white px-4 py-2 rounded-md hover:bg-red-700">
                                    <i class="fas fa-trash mr-2"></i>Eliminar Ubicaci贸n
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Lista de ubicaciones existentes -->
                    <div id="ubicaciones-list" class="mb-6">
                        <div class="text-center py-8 text-gray-500">
                            <i class="fas fa-map-marker-alt text-4xl mb-2"></i>
                            <p>Cargando ubicaciones...</p>
                        </div>
                    </div>
                                       
                    <!-- Formulario para agregar/editar ubicaci贸n -->
                    <div id="ubicacion-form-container" class="hidden bg-gray-50 p-6 rounded-lg">
                        <div class="flex justify-between items-center mb-4">
                            <h4 id="ubicacion-form-title" class="text-md font-semibold">Agregar Nueva Ubicaci贸n</h4>
                            <button onclick="hideAddLocationForm()" class="text-gray-500 hover:text-gray-700">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        
                        <form id="ubicacion-form" class="space-y-6">
                            <input type="hidden" name="id" id="ubicaciones-id">
                            
                            <!-- Plus Code -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Google Maps Plus Code *</label>
                                <input type="text" 
                                       name="gmaps_plus_code" 
                                       id="ubicaciones-gmaps_plus_code" 
                                       class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-amber-500 focus:border-amber-500"
                                       placeholder="6RXC+Q7C Colluqueo, Lonquimay"
                                       required>
                                <p class="text-xs text-gray-500 mt-1">Ejemplo: 6RXC+Q7C Colluqueo, Lonquimay</p>
                            </div>
                            
                            <!-- Nombre de ubicaci贸n -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Nombre de la ubicaci贸n *</label>
                                <input type="text" 
                                       name="nombre" 
                                       id="ubicaciones-nombre" 
                                       class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-amber-500 focus:border-amber-500"
                                       placeholder="Colmenar Principal - Colluqueo, Lonquimay"
                                       required>
                            </div>
                            
                            <!-- Latitud (oculto) -->
                            <input type="hidden" name="latitud" id="ubicaciones-latitud">
                            
                            <!-- Longitud (oculto) -->
                            <input type="hidden" name="longitud" id="ubicaciones-longitud">
                            
                            <!-- Descripci贸n -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Descripci贸n</label>
                                <textarea name="descripcion" 
                                          id="ubicaciones-descripcion" 
                                          class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-amber-500 focus:border-amber-500"
                                          placeholder="Descripci贸n adicional de la ubicaci贸n"
                                          rows="3"></textarea>
                            </div>
                            
                            <div class="flex space-x-3">
                                <button type="submit" 
                                        onclick="submitUbicacionForm(event)" 
                                        class="flex-1 bg-amber-600 text-white py-2 px-4 rounded-md hover:bg-amber-700 focus:outline-none focus:ring-2 focus:ring-amber-500 focus:ring-offset-2">
                                    <i class="fas fa-save mr-2"></i><span id="ubicacion-submit-text">Guardar Ubicaci贸n</span>
                                </button>
                                <button type="button" 
                                        onclick="hideAddLocationForm()" 
                                        class="px-4 py-2 border border-gray-300 rounded-md text-gray-700 hover:bg-gray-50">
                                    Cancelar
                                </button>
                            </div>
                        </form>
                    </div>
                    
                    <!-- Formulario para eliminar ubicaci贸n -->
                    <div id="delete-location-form-container" class="hidden bg-red-50 p-6 rounded-lg border border-red-200">
                        <div class="flex justify-between items-center mb-4">
                            <h4 class="text-md font-semibold text-red-800">Eliminar Ubicaci贸n</h4>
                            <button onclick="hideDeleteLocationForm()" class="text-gray-500 hover:text-gray-700">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        
                        <div class="mb-4">
                            <p class="text-sm text-red-600 mb-4">Selecciona la ubicaci贸n que deseas eliminar. Esta acci贸n no se puede deshacer.</p>
                            <select id="delete-location-select" class="w-full px-3 py-2 border border-red-300 rounded-md focus:outline-none focus:ring-2 focus:ring-red-500">
                                <option value="">Selecciona una ubicaci贸n...</option>
                            </select>
                        </div>
                        
                        <div class="flex justify-end space-x-3">
                            <button type="button" 
                                    onclick="confirmDeleteLocation()" 
                                    class="px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700 disabled:opacity-50">
                                <i class="fas fa-trash mr-2"></i>Eliminar
                            </button>
                            <button type="button" 
                                    onclick="hideDeleteLocationForm()" 
                                    class="px-4 py-2 border border-gray-300 rounded-md text-gray-700 hover:bg-gray-50">
                                Cancelar
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Toast Messages -->
<div id="toast" class="fixed top-4 right-4 z-50 hidden">
    <div class="bg-white border border-gray-200 rounded-lg shadow-lg p-4 max-w-sm">
        <div class="flex items-center">
            <div id="toast-icon" class="mr-3"></div>
            <div>
                <p id="toast-message" class="text-sm font-medium text-gray-900"></p>
            </div>
        </div>
    </div>
</div>

<script>
// Tab Management
function showTab(tabName) {
    // Hide all tab contents
    document.querySelectorAll('.tab-content').forEach(content => {
        content.classList.add('hidden');
    });
    
    // Remove active styles from all tabs
    document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.classList.remove('border-amber-500', 'text-amber-600');
        btn.classList.add('border-transparent', 'text-gray-500');
    });
    
    // Show selected tab content
    document.getElementById(`form-${tabName}`).classList.remove('hidden');
    
    // Add active styles to selected tab
    const activeTab = document.getElementById(`tab-${tabName}`);
    activeTab.classList.remove('border-transparent', 'text-gray-500');
    activeTab.classList.add('border-amber-500', 'text-amber-600');
    
    // Load data for the selected tab
    loadTabData(tabName);
}

// Load existing data for a tab
async function loadTabData(tabName) {
    try {
        const response = await fetch(`/api/data/${tabName}`);
        const result = await response.json();
        
        if (result.success) {
            // Obtener datos seg煤n el tipo de tab
            let data;
            if (tabName === 'usuarios') {
                data = result.usuario || result.data || {};
            } else if (tabName === 'info_contacto') {
                data = result.info_contacto || result.data || {};
            } else if (tabName === 'ubicaciones') {
                data = result.ubicaciones || result.data || [];
            } else {
                data = result.data || {};
            }
            
            // Store user ID globally for profile navigation - usar UUID completo
            if (tabName === 'usuarios' && data.auth_user_id) {
                window.currentUserId = data.auth_user_id;
                console.log('Usuario UUID completo cargado:', window.currentUserId);
            } else if (result.id) {
                // Fallback si viene en estructura diferente
                window.currentUserId = result.id;
                console.log('Usuario UUID completo cargado (fallback):', window.currentUserId);
            }
            
            // Populate form fields based on tab
            if (tabName === 'usuarios') {
                // Precargar todos los campos de usuario
                document.getElementById('usuarios-username-display').textContent = data.username || '';
                document.getElementById('usuarios-tipo_usuario').value = data.tipo_usuario || '';
                document.getElementById('usuarios-role').value = data.role || 'regular';
            } else if (tabName === 'info_contacto') {
                // Precargar todos los campos de informaci贸n de contacto
                document.getElementById('contacto-nombre_completo').value = data.nombre_completo || '';
                document.getElementById('contacto-nombre_empresa').value = data.nombre_empresa || '';
                
                // Mostrar correo en campo de solo lectura - usar el email del backend que ya incluye auth.users
                const userEmail = data.correo_principal || 'No disponible';
                document.getElementById('contacto-correo_principal-display').textContent = userEmail;
                document.getElementById('contacto-correo_principal').value = data.correo_principal || '';
                
                document.getElementById('contacto-direccion').value = data.direccion || '';
                document.getElementById('contacto-comuna').value = data.comuna || '';
                document.getElementById('contacto-region').value = data.region || '';
                document.getElementById('contacto-telefono_principal').value = data.telefono_principal || '';
            } else if (tabName === 'ubicaciones') {
                // Display all locations - usar result.ubicaciones en lugar de data
                displayUbicaciones(result.ubicaciones || []);
            }
        }
    } catch (error) {
        console.error('Error loading data:', error);
    }
}

// Form submission
async function submitForm(event, tableName) {
    event.preventDefault();
    
    const form = event.target;
    const formData = new FormData(form);
    const data = {};
    
    // Convertir FormData a objeto - SOLO incluir campos con contenido
    for (let [key, value] of formData.entries()) {
        const trimmedValue = value.trim();
        if (trimmedValue !== '') {
            data[key] = trimmedValue;
        }
    }
    
    // Si no hay ning煤n campo con contenido, mostrar advertencia
    if (Object.keys(data).length === 0) {
        showToast('warning', 'Por favor ingresa al menos un valor para guardar');
        return;
    }
    
    console.log('Enviando datos:', data);
    
    try {
        const response = await fetch(`/api/edit/${tableName}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(data)
        });
        
        const result = await response.json();
        
        if (result.success) {
            showToast('success', `${tableName.charAt(0).toUpperCase() + tableName.slice(1)} actualizado exitosamente`);
            
            // Navegar a la siguiente pesta帽a seg煤n el flujo
            setTimeout(() => {
                if (tableName === 'usuarios') {
                    showTab('info_contacto');
                } else if (tableName === 'info_contacto') {
                    showTab('ubicaciones');
                } else if (tableName === 'ubicaciones') {
                    // Redirigir al perfil despu茅s de completar ubicaciones
                    const userId = window.currentUserId;
                    if (userId && userId !== 'undefined' && userId !== 'null') {
                        const fullProfileUrl = `/profile/${userId}`;
                        console.log('Redirigiendo a perfil:', fullProfileUrl);
                        window.location.href = fullProfileUrl;
                    } else {
                        console.error('No se pudo obtener el UUID del usuario');
                        window.location.href = '/profile';
                    }
                }
            }, 1500);
        } else {
            showToast('error', result.error || 'Error al actualizar');
        }
    } catch (error) {
        console.error('Error:', error);
        showToast('error', 'Error al procesar la solicitud');
    }
}

// Funciones para autocomplete de Comuna
let comunaTimeout;
async function handleComunaInput(input) {
    const query = input.value.trim();
    
    // Capitalizar autom谩ticamente mientras escribe
    const capitalized = capitalizeWords(query);
    if (input.value !== capitalized) {
        const cursorPos = input.selectionStart;
        input.value = capitalized;
        input.setSelectionRange(cursorPos, cursorPos);
    }
    
    // Limpiar timeout anterior
    clearTimeout(comunaTimeout);
    
    if (query.length < 2) {
        hideSuggestions('comuna');
        return;
    }
    
    // Debounce para evitar muchas consultas
    comunaTimeout = setTimeout(async () => {
        try {
            const response = await fetch(`/api/suggestions/comunas?q=${encodeURIComponent(query)}`);
            const result = await response.json();
            
            if (result.success && result.suggestions) {
                showSuggestions('comuna', result.suggestions, input);
            }
        } catch (error) {
            console.error('Error obteniendo sugerencias de comunas:', error);
        }
    }, 300);
}

// Funciones para autocomplete de Regi贸n
let regionTimeout;
async function handleRegionInput(input) {
    const query = input.value.trim();
    
    // Solo capitalizar si no contiene espacios m煤ltiples o caracteres especiales
    // Permitir espacios para regiones como "La Araucan铆a" y "Los Lagos"
    const capitalized = capitalizeWordsPreservingSpaces(query);
    if (input.value !== capitalized) {
        const cursorPos = input.selectionStart;
        input.value = capitalized;
        input.setSelectionRange(cursorPos, cursorPos);
    }
    
    // Limpiar timeout anterior
    clearTimeout(regionTimeout);
    
    if (query.length < 2) {
        hideSuggestions('region');
        return;
    }
    
    // Debounce para evitar muchas consultas
    regionTimeout = setTimeout(async () => {
        try {
            const response = await fetch(`/api/suggestions/regiones?q=${encodeURIComponent(query)}`);
            const result = await response.json();
            
            if (result.success && result.suggestions) {
                showSuggestions('region', result.suggestions, input);
            }
        } catch (error) {
            console.error('Error obteniendo sugerencias de regiones:', error);
        }
    }, 300);
}

// Funci贸n para capitalizar palabras preservando espacios
function capitalizeWordsPreservingSpaces(str) {
    // Preservar espacios m煤ltiples y solo capitalizar palabras reales
    return str.replace(/\b\w+/g, function(word) {
        return word.charAt(0).toUpperCase() + word.slice(1).toLowerCase();
    });
}

// Funci贸n para capitalizar palabras (mantener compatibilidad)
function capitalizeWords(str) {
    return capitalizeWordsPreservingSpaces(str);
}

// Mostrar sugerencias
function showSuggestions(type, suggestions, inputElement) {
    const suggestionsContainer = document.getElementById(`${type}-suggestions`);
    
    if (suggestions.length === 0) {
        hideSuggestions(type);
        return;
    }
    
    suggestionsContainer.innerHTML = '';
    
    suggestions.forEach(suggestion => {
        const suggestionItem = document.createElement('div');
        suggestionItem.className = 'px-3 py-2 cursor-pointer hover:bg-amber-50 text-sm';
        suggestionItem.textContent = suggestion;
        
        suggestionItem.addEventListener('mousedown', (e) => {
            e.preventDefault(); // Prevenir que se active onblur antes del click
            inputElement.value = suggestion;
            hideSuggestions(type);
            inputElement.focus();
        });
        
        suggestionsContainer.appendChild(suggestionItem);
    });
    
    suggestionsContainer.classList.remove('hidden');
}

// Ocultar sugerencias
function hideSuggestions(type) {
    setTimeout(() => {
        const suggestionsContainer = document.getElementById(`${type}-suggestions`);
        if (suggestionsContainer) {
            suggestionsContainer.classList.add('hidden');
        }
    }, 150); // Peque帽o delay para permitir clicks en sugerencias
}

// Funciones para gesti贸n de ubicaciones
function showAddLocationForm() {
    document.getElementById('ubicacion-form-container').classList.remove('hidden');
    document.getElementById('ubicacion-form-title').textContent = 'Agregar Nueva Ubicaci贸n';
    document.getElementById('ubicacion-submit-text').textContent = 'Guardar Ubicaci贸n';
    document.getElementById('ubicacion-form').reset();
    document.getElementById('ubicaciones-id').value = '';
}

function hideAddLocationForm() {
    document.getElementById('ubicacion-form-container').classList.add('hidden');
    document.getElementById('ubicacion-form').reset();
}

function editUbicacion(ubicacion) {
    document.getElementById('ubicacion-form-container').classList.remove('hidden');
    document.getElementById('ubicacion-form-title').textContent = 'Editar Ubicaci贸n';
    document.getElementById('ubicacion-submit-text').textContent = 'Actualizar Ubicaci贸n';
    
    // Llenar el formulario con los datos existentes
    document.getElementById('ubicaciones-id').value = ubicacion.id || '';
    document.getElementById('ubicaciones-gmaps_plus_code').value = ubicacion.gmaps_plus_code || '';
    document.getElementById('ubicaciones-nombre').value = ubicacion.nombre || '';
    document.getElementById('ubicaciones-latitud').value = ubicacion.latitud || '';
    document.getElementById('ubicaciones-longitud').value = ubicacion.longitud || '';
    document.getElementById('ubicaciones-descripcion').value = ubicacion.descripcion || '';
}

function displayUbicaciones(ubicaciones) {
    const container = document.getElementById('ubicaciones-list');
    
    if (!Array.isArray(ubicaciones) || ubicaciones.length === 0) {
        container.innerHTML = `
            <div class="text-center py-8 text-gray-500">
                <i class="fas fa-map-marker-alt text-4xl mb-2"></i>
                <p>No tienes ubicaciones registradas</p>
                <button onclick="showAddLocationForm()" class="mt-4 text-amber-600 hover:text-amber-700">
                    <i class="fas fa-plus mr-1"></i>Agregar primera ubicaci贸n
                </button>
            </div>
        `;
        return;
    }
    
    container.innerHTML = ubicaciones.map(ubicacion => `
        <div class="bg-white border border-gray-200 rounded-lg p-4 mb-4">
            <div class="flex justify-between items-start">
                <div class="flex-1">
                    <h4 class="font-semibold text-gray-900">${ubicacion.nombre || 'Sin nombre'}</h4>
                    <p class="text-sm text-gray-600 mt-1">${ubicacion.descripcion || 'Sin descripci贸n'}</p>
                    <div class="mt-2">
                        <span class="text-xs bg-gray-100 text-gray-700 px-2 py-1 rounded">${ubicacion.gmaps_plus_code}</span>
                        <a href="https://maps.google.com/?q=${ubicacion.latitud},${ubicacion.longitud}" 
                           target="_blank" 
                           class="text-xs text-amber-600 hover:text-amber-700 ml-2">
                            <i class="fas fa-external-link-alt mr-1"></i>Ver en Maps
                        </a>
                    </div>
                </div>
                <div class="flex space-x-2 ml-4">
                    <button onclick='editUbicacion(${JSON.stringify(ubicacion).replace(/'/g, "&apos;")})' 
                            class="text-blue-600 hover:text-blue-800 p-1">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button onclick='deleteUbicacion("${ubicacion.id}")' 
                            class="text-red-600 hover:text-red-800 p-1">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>
        </div>
    `).join('');
}

async function deleteUbicacion(id) {
    if (!confirm('驴Est谩s seguro de eliminar esta ubicaci贸n?')) return;
    
    try {
        const response = await fetch('/api/edit/ubicaciones', {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ id })
        });
        
        const result = await response.json();
        if (result.success) {
            showToast('Ubicaci贸n eliminada exitosamente', 'success');
            loadTabData('ubicaciones');
        } else {
            showToast('Error: ' + result.error, 'error');
        }
    } catch (error) {
        console.error('Error:', error);
        showToast('Error al eliminar ubicaci贸n', 'error');
    }
}

// Funci贸n actualizada para enviar formulario de ubicaciones
async function submitUbicacionForm(event) {
    event.preventDefault();
    
    const form = document.getElementById('ubicacion-form');
    const formData = new FormData(form);
    
    // Convertir FormData a objeto
    const data = {};
    formData.forEach((value, key) => {
        data[key] = value;
    });
    
    // Limpiar Plus Code (remover texto adicional)
    if (data.gmaps_plus_code) {
        // Extraer solo el Plus Code (ej: "6RXC+Q7C" de "6RXC+Q7C Colluqueo")
        const plusCodeMatch = data.gmaps_plus_code.match(/([23456789CFGHJMPQRVWX]{8,}[+]?[23456789CFGHJMPQRVWX]{2,})/i);
        if (plusCodeMatch) {
            data.gmaps_plus_code = plusCodeMatch[1].toUpperCase();
        }
    }
    
    console.log(' Enviando datos:', data);
    
    // Determinar m茅todo HTTP seg煤n si es edici贸n o creaci贸n
    const method = data.id ? 'PUT' : 'POST';
    
    // Enviar al backend
    fetch('/api/edit/ubicaciones', {
        method: method,
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(result => {
        console.log(' Respuesta:', result);
        if (result.success) {
            showToast('Ubicaci贸n guardada exitosamente', 'success');
            hideAddLocationForm();
            loadTabData('ubicaciones');
            form.reset();
        } else {
            showToast('Error: ' + result.error, 'error');
        }
    })
    .catch(error => {
        console.error(' Error:', error);
        showToast('Error al guardar ubicaci贸n', 'error');
    });
}

// Toast notifications
function showToast(message, type = 'info') {
    const toast = document.getElementById('toast');
    const icon = document.getElementById('toast-icon');
    const messageEl = document.getElementById('toast-message');

    // Set icon and colors based on type
    if (type === 'success') {
        icon.innerHTML = '<i class="fas fa-check-circle text-green-500"></i>';
        toast.querySelector('div').classList.add('border-green-200');
    } else if (type === 'error') {
        icon.innerHTML = '<i class="fas fa-exclamation-circle text-red-500"></i>';
        toast.querySelector('div').classList.add('border-red-200');
    } else {
        icon.innerHTML = '<i class="fas fa-info-circle text-blue-500"></i>';
        toast.querySelector('div').classList.add('border-blue-200');
    }
    
    messageEl.textContent = message;
    toast.classList.remove('hidden');
    
    // Auto hide after 5 seconds
    setTimeout(() => {
        toast.classList.add('hidden');
        // Reset classes
        toast.querySelector('div').classList.remove('border-green-200', 'border-red-200', 'border-blue-200');
    }, 5000);
}

// Mostrar formulario de agregar ubicaci贸n
function showAddLocationForm() {
    document.getElementById('ubicacion-form-container').classList.remove('hidden');
    document.getElementById('delete-location-form-container').classList.add('hidden');
}

// Ocultar formulario de agregar ubicaci贸n
function hideAddLocationForm() {
    document.getElementById('ubicacion-form-container').classList.add('hidden');
}

// Mostrar formulario de eliminar ubicaci贸n
function showDeleteLocationForm() {
    document.getElementById('delete-location-form-container').classList.remove('hidden');
    document.getElementById('ubicacion-form-container').classList.add('hidden');
    loadLocationOptions();
}

// Ocultar formulario de eliminar ubicaci贸n
function hideDeleteLocationForm() {
    document.getElementById('delete-location-form-container').classList.add('hidden');
}

// Cargar opciones de ubicaciones para eliminar
async function loadLocationOptions() {
    try {
        const response = await fetch('/api/data/ubicaciones');
        const result = await response.json();
        
        const select = document.getElementById('delete-location-select');
        select.innerHTML = '<option value="">Selecciona una ubicaci贸n...</option>';
        
        if (result.success && result.ubicaciones && result.ubicaciones.length > 0) {
            result.ubicaciones.forEach(ubicacion => {
                const option = document.createElement('option');
                option.value = ubicacion.id;
                option.textContent = `${ubicacion.nombre} (${ubicacion.latitud}, ${ubicacion.longitud})`;
                select.appendChild(option);
            });
        } else {
            const option = document.createElement('option');
            option.value = '';
            option.textContent = 'No hay ubicaciones para eliminar';
            option.disabled = true;
            select.appendChild(option);
        }
    } catch (error) {
        console.error('Error cargando ubicaciones:', error);
        showToast('Error cargando ubicaciones', 'error');
    }
}

// Confirmar eliminaci贸n de ubicaci贸n
async function confirmDeleteLocation() {
    const select = document.getElementById('delete-location-select');
    const locationId = select.value;
    
    if (!locationId) {
        showToast('Por favor selecciona una ubicaci贸n', 'error');
        return;
    }
    
    if (!confirm('驴Est谩s seguro de que deseas eliminar esta ubicaci贸n? Esta acci贸n no se puede deshacer.')) {
        return;
    }
    
    try {
        const response = await fetch('/api/edit/ubicaciones', {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ id: locationId })
        });
        
        const result = await response.json();
        
        if (result.success) {
            showToast('Ubicaci贸n eliminada correctamente', 'success');
            hideDeleteLocationForm();
            // Recargar la lista de ubicaciones
            loadTabData('ubicaciones');
        } else {
            showToast(result.error || 'Error eliminando ubicaci贸n', 'error');
        }
    } catch (error) {
        console.error('Error eliminando ubicaci贸n:', error);
        showToast('Error eliminando ubicaci贸n', 'error');
    }
}

// Mostrar ubicaciones en la lista
function displayUbicaciones(ubicaciones) {
    const container = document.getElementById('ubicaciones-list');
    
    if (!ubicaciones || ubicaciones.length === 0) {
        container.innerHTML = `
            <div class="text-center py-8 text-gray-500">
                <i class="fas fa-map-marker-alt text-4xl mb-2"></i>
                <p>No hay ubicaciones registradas</p>
            </div>
        `;
        return;
    }
    
    container.innerHTML = ubicaciones.map(ubicacion => `
        <div class="bg-white border border-gray-200 rounded-lg p-4 mb-3">
            <div class="flex justify-between items-start">
                <div>
                    <h4 class="font-semibold text-gray-900">${ubicacion.nombre}</h4>
                    <p class="text-sm text-gray-600">Lat: ${ubicacion.latitud}, Lng: ${ubicacion.longitud}</p>
                    ${ubicacion.descripcion ? `<p class="text-sm text-gray-500 mt-1">${ubicacion.descripcion}</p>` : ''}
                </div>
                <div class="text-xs text-gray-400">
                    ${ubicacion.norma_geo || 'WGS84'}
                </div>
            </div>
        </div>
    `).join('');
}

// Navigate to profile using already loaded user ID
function goToProfile() {
    if (window.currentUserId) {
        window.location.href = `/profile/${window.currentUserId}`;
    } else {
        window.location.href = '/profile';
    }
}

// Initialize page
document.addEventListener('DOMContentLoaded', function() {
    showTab('usuarios'); // Show first tab by default
    
    // Precargar datos de todas las pesta帽as
    setTimeout(() => {
        loadTabData('info_contacto');
        loadTabData('ubicaciones');
    }, 500);
});
</script>
{% endblock %}
